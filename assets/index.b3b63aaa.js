var _=Object.defineProperty;var L=(e,t,a)=>t in e?_(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a;var l=(e,t,a)=>(L(e,typeof t!="symbol"?t+"":t,a),a);import{l as C,_ as D,f as R,a as z,b as B,c as M,d as $,e as U,g as F,h as j,i as G,j as q,k as O,m as Z,n as o,o as s,B as p,F as d,p as Y,q as W,r as H,s as m,R as X,t as Q}from"./vendor.8dbe3e76.js";const J=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const c of i.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&r(c)}).observe(document,{childList:!0,subtree:!0});function a(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerpolicy&&(i.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?i.credentials="include":n.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(n){if(n.ep)return;n.ep=!0;const i=a(n);fetch(n.href,i)}};J();C.add(D,R,z,B,M,$,U,F,j,G,q,O,Z);function I(e){e=e.replace(/[[]/,"\\[").replace(/[\]]/,"\\]");const t=new RegExp("[\\?&]"+e+"=([^&#]*)"),a=t.exec(window.location.search);return a===null?"":decodeURIComponent(a[1].replace(/\+/g," "))}function V(){return o("form",{className:"login-container",onSubmit:e=>{e.preventDefault(),K(e)},children:[s("input",{id:"clientId",required:!0,minLength:32,maxLength:32,type:"password",placeholder:"Enter client id..."}),o(p,{type:"submit",variant:"outline-secondary",size:"lg",children:[s(d,{icon:["far","check-circle"],size:"sm"})," Get Started"]})]})}function K(e){const{clientId:{value:t}}=e.target.elements,a=I("change_user")!=="";window.location.href="https://accounts.spotify.com/authorize?client_id="+t+"&redirect_uri="+encodeURIComponent([window.location.protocol,"//",window.location.host,window.location.pathname].join(""))+"&scope=playlist-read-private%20playlist-read-collaborative%20user-library-read%20playlist-modify-private%20playlist-modify-public&response_type=token&show_dialog="+a}const b=1e3,tt=2,T=new Y({maxConcurrent:1,minTime:0}),y=T.wrap(function(e,t){return W.get(e,{headers:{Authorization:"Bearer "+t}})});function h(e){if(e.isAxiosError){if(e.request.status===401){window.location.href=window.location.href.split("#")[0];return}else if(e.request.status>=500&&e.request.status<600){window.location.href=`${window.location.href.split("#")[0]}?spotify_error=true`;return}}throw e}T.on("failed",async(e,t)=>{if(e.response.status===429&&t.retryCount<tt)return(e.response.headers["retry-after"]||1)*1e3+b;if(e.response.status!==401&&e.response.status!==429&&t.retryCount===0)return b});class et{constructor(t,a){l(this,"PLAYLIST_LIMIT",50);l(this,"SEARCH_LIMIT",20);l(this,"userId");l(this,"accessToken");l(this,"data");l(this,"dataInitialized",!1);this.accessToken=t,this.userId=a,this.data=[]}async total(){return this.dataInitialized||await this.loadSlice(),this.data.length}async slice(t,a){return await this.loadSlice(t,a),this.data.slice(t,a)}async all(){return await this.loadAll(),this.data}async loadAll(){await this.loadSlice();for(let t=this.PLAYLIST_LIMIT;t<this.data.length;t=t+this.PLAYLIST_LIMIT)await this.loadSlice(t,t+this.PLAYLIST_LIMIT)}async loadSlice(t=0,a=t+this.PLAYLIST_LIMIT){if(this.dataInitialized){const c=this.data.slice(t,a);if(c.filter(u=>!u).length===0)return c}const r=`https://api.spotify.com/v1/users/${this.userId}/playlists?offset=${t}&limit=${a-t}`,i=(await y(r,this.accessToken)).data;this.dataInitialized||(this.data=Array(i.total).fill(null),this.dataInitialized=!0),this.data.splice(t,i.items.length,...i.items)}}class at{constructor(t){l(this,"accessToken");this.accessToken=t}}class x extends at{constructor(t,a){super(t);l(this,"playlist");l(this,"playlistItems",[]);this.playlist=a}dataLabels(){return["Track URI","Track Name","Artist URI(s)","Artist Name(s)","Album URI","Album Name","Album Artist URI(s)","Album Artist Name(s)","Album Release Date","Album Image URL","Disc Number","Track Number","Track Duration (ms)","Track Preview URL","Explicit","Popularity"]}async trackItems(){return await this.getPlaylistItems(),this.playlistItems}async data(){return await this.getPlaylistItems(),new Map(this.playlistItems.map(t=>[t.track.uri,[t.track.uri,t.track.name,t.track.artists.map(a=>a.uri).join(", "),t.track.artists.map(a=>String(a.name).replace(/,/g,"\\,")).join(", "),t.track.album.uri==null?"":t.track.album.uri,t.track.album.name,t.track.album.artists.map(a=>a.uri).join(", "),t.track.album.artists.map(a=>String(a.name).replace(/,/g,"\\,")).join(", "),t.track.album.release_date==null?"":t.track.album.release_date,t.track.album.images[0]==null?"":t.track.album.images[0].url,t.track.disc_number,t.track.track_number,t.track.duration_ms,t.track.preview_url==null?"":t.track.preview_url,t.track.explicit,t.track.popularity]]))}async getPlaylistItems(){if(this.playlistItems.length>0)return this.playlistItems;const t=[],a=this.playlist.tracks.limit||100;for(let i=0;i<this.playlist.tracks.total;i=i+a)t.push(`${this.playlist.tracks.href.split("?")[0]}?offset=${i}&limit=${a}`);const r=t.map(i=>y(i,this.accessToken)),n=await Promise.all(r);this.playlistItems=n.flatMap(i=>i.data.items.filter(c=>c.track))}}class st{constructor(t,a){l(this,"playlist");l(this,"trackItems");l(this,"columnNames");l(this,"lineData");l(this,"lineTrackUris");l(this,"lineTrackData");this.playlist=t,this.trackItems=a,this.columnNames=["Added By","Added At"],this.lineData=new Map,this.lineTrackUris=a.map(r=>r.track.uri),this.lineTrackData=a.map(r=>[r.added_by==null?"":r.added_by.uri,r.added_at])}async addData(t,a=!1){a?this.columnNames.unshift(...t.dataLabels()):this.columnNames.push(...t.dataLabels());const r=await t.data();this.lineTrackUris.forEach((n,i)=>{r.has(n)&&(a?this.lineTrackData[i].unshift(...r.get(n)):this.lineTrackData[i].push(...r.get(n)))})}content(){let t="";return t+=this.columnNames.map(this.sanitize).join()+`
`,this.lineTrackData.forEach(a=>{t+=a.map(this.sanitize).join(",")+`
`}),t}sanitize(t){return'"'+String(t).replace(/"/g,'""')+'"'}}class rt{constructor(t,a,r){l(this,"accessToken");l(this,"playlist");l(this,"setIsLoading");this.accessToken=t,this.playlist=a,this.setIsLoading=r}async export(){return this.setIsLoading(!0),this.csvData().then(t=>{const a=new Blob([t],{type:"text/csv;charset=utf-8"});H.exports.saveAs(a,this.fileName()),this.setIsLoading(!1)})}async csvData(){const t=new x(this.accessToken,this.playlist),a=await t.trackItems(),r=new st(this.playlist,a);return await r.addData(t,!0),r.content()}fileName(){return this.playlist.name.replace(/[\x00-\x1F\x7F/\\<>:;"|=,.?*[\] ]+/g,"_").toLowerCase()+".csv"}}function A(e,t){if(!Array.isArray(e))throw new Error("Not supported");for(var a=[],r=0;r<e.length;r++){var n=t(e[r]);a.push(n)}return a}var it=function(e,t){for(var a=0,r=e.length;a<r;a++){var n=e[a];e[a]={item:n,values:A(t,function(i){return i.func(n)})}}},nt=function(e){for(var t=0,a=e.length;t<a;t++)e[t]=e[t].item},lt=function(e){if(dt(e))return ot(e);if(pt(e))return ut(e);if(ht(e))return ct(e);throw"Improper input for comparator!"},ot=function(e){return{func:e,invert:!1}},ct=function(e){return{func:function(t){return t},invert:e<0}},ut=function(e){var t;return(e[0]==="!"||e[0]==="~")&&(e=e.slice(1),t=!0),e[0]==="."&&(e=e.slice(1)),e[e.length-1]==="?"?(e=e.slice(0,-1),{func:function(a){return S(a,e)!=null},invert:t}):{func:function(a){return S(a,e)},invert:t}},S=function(e,t){if(t==="")return e;t=t.split(".");for(var a=e;t.length;){var r=t.shift();if(/[^\(\r\n]*\([^\(\r\n]*\)$/.test(r)){var n=r.indexOf("("),i=JSON.parse("["+r.slice(n+1,-1)+"]");r=r.slice(0,n)}if(i?a=a[r].apply(a,i):a=a[r],a==null)return null}return a},dt=function(e){return typeof e=="function"},ht=function(e){return typeof e=="number"},pt=function(e){return typeof e=="string"};function ft(e,t){Array.isArray(t)||(t=[t]);var a=A(t,lt);return it(e,a),e.sort(function(r,n){for(var i=r.values,c=n.values,u=0,f=a.length;u<f;u++){var k=a[u].invert,w=i[u],v=c[u];if(w>v)return k?-1:1;if(v>w)return k?1:-1}return 0}),nt(e),e}class mt{constructor(t,a,r){l(this,"accessToken");l(this,"playlist");l(this,"setIsLoading");this.accessToken=t,this.playlist=a,this.setIsLoading=r}async sort(){const t=new x(this.accessToken,this.playlist);this.setIsLoading(!0);const r=(await t.trackItems()).map(({track:i})=>({trackNumber:i.track_number.toString().padStart(2,"0"),artist:E(i.artists[0].name),albumName:E(i.album.name),releaseDate:new Date(i.album.release_date),uri:i.uri})),n=ft(r,["artist","releaseDate","albumName","track"]);console.log("items",n),this.setIsLoading(!1)}}function E(e){let t=e;return e.toLowerCase().startsWith("a ")?t=e.substring(2):e.toLowerCase().startsWith("the ")?t=e.substring(4):e.startsWith("$")&&(t=e.replace("$","S")),t.toLowerCase()}function yt({playlist:e,accessToken:t,index:a}){const[r,n]=m.exports.useState(!1),[i,c]=m.exports.useState(!1),u=()=>{new rt(t,e,c).export().catch(h)},f=()=>{new mt(t,e,n).sort().catch(h)};return e.uri==null?o("tr",{className:P(a)?"":"alt-color",children:[s("td",{children:"\xA0"}),s("td",{children:e.name}),s("td",{colSpan:2,children:"This playlist is not supported"}),s("td",{children:"\xA0"}),s("td",{children:"\xA0"})]},e.name):o("tr",{className:P(a)?"":"alt-color",children:[s("td",{children:s("img",{alt:"cover",style:{width:"60px",height:"60px",objectFit:"cover",marginRight:"40px"},src:e.images[0].url})}),s("td",{className:"align-middle",children:s("a",{href:e.uri,children:e.name})}),s("td",{className:"align-middle",children:e.tracks.total}),s("td",{className:"text-center align-middle",children:o(p,{type:"submit",variant:"primary",onClick:f,className:"text-nowrap text-center button-flex",children:[r?s(N,{}):s(d,{icon:["fas","sort-amount-down-alt"],size:"sm"})," ","Sort"]})}),s("td",{className:"text-center align-middle",children:o(p,{type:"submit",variant:"primary",onClick:u,className:"text-nowrap text-center button-flex",children:[i?s(N,{}):s(d,{icon:["fas","download"],size:"sm"})," ","Export"]})})]},e.uri)}function N(){return s("div",{className:"loader",children:s("div",{className:"loader__content"})})}function P(e){return e%2==0}function gt({onPageChanged:e,currentPage:t,totalRecords:a,pageLimit:r}){const n=u=>{u.preventDefault(),e(t+1)},i=u=>{u.preventDefault(),e(t-1)},c=()=>Math.ceil(a/r);return s("nav",{className:"paginator text-right",children:o("ul",{className:"pagination pagination-sm",children:[s("li",{className:t<=1?"page-item disabled":"page-item",children:s("a",{className:"page-link",href:"#","aria-label":"Previous",onClick:i,children:s("span",{"aria-hidden":"true",children:"\xAB"})})}),s("li",{className:t>=c()?"page-item disabled":"page-item",children:s("a",{className:"page-link",href:"#","aria-label":"Next",onClick:n,children:s("span",{"aria-hidden":"true",children:"\xBB"})})})]})})}class kt extends X.Component{constructor(){super(...arguments);l(this,"PAGE_SIZE",20);l(this,"userId",null);l(this,"playlistsData",null);l(this,"state",{initialized:!1,searching:!1,playlists:[],playlistCount:0,currentPage:1});l(this,"loadCurrentPlaylistPage",async()=>{try{const t=await this.playlistsData.slice((this.state.currentPage-1)*this.PAGE_SIZE,(this.state.currentPage-1)*this.PAGE_SIZE+this.PAGE_SIZE);this.setState({initialized:!0,searching:!1,playlists:t,playlistCount:await this.playlistsData.total()},()=>{const a=(this.state.currentPage-1)*this.PAGE_SIZE+1,r=Math.min(a+this.PAGE_SIZE-1,this.state.playlistCount);this.setSubtitle(`${a}-${r} of ${this.state.playlistCount} playlists for ${this.userId}`)})}catch(t){h(t)}});l(this,"handlePageChanged",t=>{try{this.setState({currentPage:t},this.loadCurrentPlaylistPage)}catch(a){h(a)}})}setSubtitle(t){const a=document.getElementById("subtitle");a&&(a.textContent=t)}async componentDidMount(){try{const t=await y("https://api.spotify.com/v1/me",this.props.accessToken).then(a=>a.data);this.userId=t.id,this.playlistsData=new et(this.props.accessToken,this.userId),await this.loadCurrentPlaylistPage()}catch(t){h(t)}}render(){return this.state.initialized?o("div",{id:"playlists",children:[o("table",{className:"table table-hover table-sm",children:[s("thead",{children:o("tr",{children:[s("th",{style:{width:"100px"}}),s("th",{children:"Name"}),s("th",{children:"Tracks"}),s("th",{style:{width:"120px"},className:"text-center"}),s("th",{style:{width:"120px"},className:"text-right"})]})}),s("tbody",{children:this.state.playlists.map((t,a)=>s(yt,{playlist:t,index:a,accessToken:this.props.accessToken},t.id))})]}),s("div",{id:"playlistsFooter",children:s(gt,{currentPage:this.state.currentPage,pageLimit:this.PAGE_SIZE,totalRecords:this.state.playlistCount,onPageChanged:this.handlePageChanged})})]}):s("div",{className:"spinner"})}}function wt(){return s(p,{id:"logoutButton",type:"submit",variant:"link",size:"lg",onClick:()=>{window.location.href=`${window.location.href.split("#")[0]}?change_user=true`},title:"Change user",children:s(d,{icon:["fas","sign-out-alt"],size:"lg"})})}function vt(){return o("div",{id:"spotifyErrorMessage",className:"lead",children:[s("p",{children:s(d,{icon:["fas","bolt"],style:{fontSize:"50px",marginBottom:"20px"}})}),s("p",{children:"Oops, Exportify has encountered an unexpected error (5XX) while using the Spotify API. This kind of error is due to a problem on Spotify's side, and although it's rare, unfortunately all we can do is retry later."}),o("p",{style:{marginTop:"50px"},children:["Keep an eye on the"," ",s("a",{target:"_blank",rel:"noreferrer",href:"https://status.spotify.dev/",children:"Spotify Web API Status page"})," ","to see if there are any known problems right now, and then"," ",s("a",{rel:"noreferrer",href:"?",children:"retry"}),"."]})]})}function It(){const e=new URLSearchParams(window.location.hash.substring(1));return I("spotify_error")!==""?s(g,{children:s(vt,{})}):e.has("access_token")?s(g,{logoutElement:s(wt,{}),children:s(kt,{accessToken:e.get("access_token")})}):s(g,{children:s(V,{})})}function g({children:e,logoutElement:t=null}){return o("div",{className:"App container",children:[o("header",{className:"App-header",children:[t,o("h1",{children:[s(d,{icon:["fab","spotify"],color:"#84BD00",size:"sm"})," ","Hatlaron's Exportify"]}),s("p",{id:"subtitle",className:"lead text-secondary",children:"Export your Spotify playlists."})]}),e]})}Q.render(s(m.exports.StrictMode,{children:s(It,{})}),document.getElementById("root"));
