var b=Object.defineProperty;var P=(i,t,e)=>t in i?b(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var n=(i,t,e)=>(P(i,typeof t!="symbol"?t+"":t,e),e);import{l as A,_ as L,f as S,a as x,b as _,c as C,d as v,e as D,g as E,h as M,i as R,j as N,k as B,m as d,n as s,B as g,F as h,o as U,p as z,q as $,R as p,P as j,r as O,s as q}from"./vendor.67968114.js";const F=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))c(o);new MutationObserver(o=>{for(const l of o)if(l.type==="childList")for(const r of l.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&c(r)}).observe(document,{childList:!0,subtree:!0});function e(o){const l={};return o.integrity&&(l.integrity=o.integrity),o.referrerpolicy&&(l.referrerPolicy=o.referrerpolicy),o.crossorigin==="use-credentials"?l.credentials="include":o.crossorigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function c(o){if(o.ep)return;o.ep=!0;const l=e(o);fetch(o.href,l)}};F();A.add(L,S,x,_,C,v,D,E,M,R,N,B);function w(i){i=i.replace(/[[]/,"\\[").replace(/[\]]/,"\\]");const t=new RegExp("[\\?&]"+i+"=([^&#]*)"),e=t.exec(window.location.search);return e===null?"":decodeURIComponent(e[1].replace(/\+/g," "))}function G(){return d("form",{className:"login-container",onSubmit:i=>{i.preventDefault(),Z(i)},children:[s("input",{id:"clientId",required:!0,minLength:32,maxLength:32,type:"password",placeholder:"Enter client id..."}),d(g,{type:"submit",variant:"outline-secondary",size:"lg",children:[s(h,{icon:["far","check-circle"],size:"sm"})," Get Started"]})]})}function Z(i){const{clientId:{value:t}}=i.target.elements,e=w("change_user")!=="";window.location.href="https://accounts.spotify.com/authorize?client_id="+t+"&redirect_uri="+encodeURIComponent([window.location.protocol,"//",window.location.host,window.location.pathname].join(""))+"&scope=playlist-read-private%20playlist-read-collaborative%20user-library-read&response_type=token&show_dialog="+e}const T=1e3,Y=2,I=new U({maxConcurrent:1,minTime:0}),u=I.wrap(function(i,t){return z.get(i,{headers:{Authorization:"Bearer "+t}})});function m(i){if(i.isAxiosError){if(i.request.status===401){window.location.href=window.location.href.split("#")[0];return}else if(i.request.status>=500&&i.request.status<600){window.location.href=`${window.location.href.split("#")[0]}?spotify_error=true`;return}}throw i}I.on("failed",async(i,t)=>{if(i.response.status===429&&t.retryCount<Y)return(i.response.headers["retry-after"]||1)*1e3+T;if(i.response.status!==401&&i.response.status!==429&&t.retryCount===0)return T});class H{constructor(t,e,c,o){n(this,"PLAYLIST_LIMIT",50);n(this,"SEARCH_LIMIT",20);n(this,"userId");n(this,"accessToken");n(this,"onPlaylistsLoadingStarted");n(this,"onPlaylistsLoadingDone");n(this,"data");n(this,"likedTracksPlaylist");n(this,"dataInitialized",!1);this.accessToken=t,this.userId=e,this.onPlaylistsLoadingStarted=c,this.onPlaylistsLoadingDone=o,this.data=[],this.likedTracksPlaylist=null}async total(){return this.dataInitialized||await this.loadSlice(),this.data.length}async slice(t,e){return await this.loadSlice(t,e),await this.loadLikedTracksPlaylist(),t===0?[this.likedTracksPlaylist,...this.data.slice(t,e)]:this.data.slice(t,e)}async all(){return await this.loadAll(),await this.loadLikedTracksPlaylist(),[this.likedTracksPlaylist,...this.data]}async search(t){return await this.loadAll(),this.data.filter(e=>e.name.toLowerCase().includes(t.toLowerCase())).slice(0,this.SEARCH_LIMIT)}async loadAll(){this.onPlaylistsLoadingStarted&&this.onPlaylistsLoadingStarted(),await this.loadSlice();for(let t=this.PLAYLIST_LIMIT;t<this.data.length;t=t+this.PLAYLIST_LIMIT)await this.loadSlice(t,t+this.PLAYLIST_LIMIT);this.onPlaylistsLoadingDone&&this.onPlaylistsLoadingDone()}async loadSlice(t=0,e=t+this.PLAYLIST_LIMIT){if(this.dataInitialized){const r=this.data.slice(t,e);if(r.filter(a=>!a).length===0)return r}const c=`https://api.spotify.com/v1/users/${this.userId}/playlists?offset=${t}&limit=${e-t}`,l=(await u(c,this.accessToken)).data;this.dataInitialized||(this.data=Array(l.total).fill(null),this.dataInitialized=!0),this.data.splice(t,l.items.length,...l.items)}async loadLikedTracksPlaylist(){if(this.likedTracksPlaylist!==null)return;const t=`https://api.spotify.com/v1/users/${this.userId}/tracks`,c=(await u(t,this.accessToken)).data;this.likedTracksPlaylist={id:"liked",name:"Liked",public:!1,collaborative:!1,owner:{id:this.userId,display_name:this.userId,uri:"spotify:user:"+this.userId},tracks:{href:"https://api.spotify.com/v1/me/tracks",limit:c.limit,total:c.total},uri:"spotify:user:"+this.userId+":saved"}}}class y{constructor(t){n(this,"accessToken");this.accessToken=t}}class K extends y{constructor(t,e){super(t);n(this,"playlist");n(this,"playlistItems",[]);this.playlist=e}dataLabels(){return["Track URI","Track Name","Artist URI(s)","Artist Name(s)","Album URI","Album Name","Album Artist URI(s)","Album Artist Name(s)","Album Release Date","Album Image URL","Disc Number","Track Number","Track Duration (ms)","Track Preview URL","Explicit","Popularity"]}async trackItems(){return await this.getPlaylistItems(),this.playlistItems}async data(){return await this.getPlaylistItems(),new Map(this.playlistItems.map(t=>[t.track.uri,[t.track.uri,t.track.name,t.track.artists.map(e=>e.uri).join(", "),t.track.artists.map(e=>String(e.name).replace(/,/g,"\\,")).join(", "),t.track.album.uri==null?"":t.track.album.uri,t.track.album.name,t.track.album.artists.map(e=>e.uri).join(", "),t.track.album.artists.map(e=>String(e.name).replace(/,/g,"\\,")).join(", "),t.track.album.release_date==null?"":t.track.album.release_date,t.track.album.images[0]==null?"":t.track.album.images[0].url,t.track.disc_number,t.track.track_number,t.track.duration_ms,t.track.preview_url==null?"":t.track.preview_url,t.track.explicit,t.track.popularity]]))}async getPlaylistItems(){if(this.playlistItems.length>0)return this.playlistItems;const t=[],e=this.playlist.tracks.limit||100;for(let l=0;l<this.playlist.tracks.total;l=l+e)t.push(`${this.playlist.tracks.href.split("?")[0]}?offset=${l}&limit=${e}`);const c=t.map(l=>u(l,this.accessToken)),o=await Promise.all(c);this.playlistItems=o.flatMap(l=>l.data.items.filter(r=>r.track))}}class X extends y{constructor(t,e){super(t);n(this,"ARTIST_LIMIT",50);n(this,"tracks");this.tracks=e}dataLabels(){return["Artist Genres"]}async data(){const t=Array.from(new Set(this.tracks.flatMap(r=>r.artists.filter(a=>a.type==="artist").map(a=>a.id).filter(a=>a)))),e=[];for(let r=0;r<t.length;r=r+this.ARTIST_LIMIT)e.push(`https://api.spotify.com/v1/artists?ids=${t.slice(r,r+this.ARTIST_LIMIT)}`);const c=e.map(r=>u(r,this.accessToken)),o=await Promise.all(c),l=new Map(o.flatMap(r=>r.data.artists).map(r=>[r.id,r]));return new Map(this.tracks.map(r=>[r.uri,[r.artists.map(a=>l.has(a.id)?l.get(a.id).genres.filter(f=>f).join(","):"").filter(a=>a).join(",")]]))}}class Q extends y{constructor(t,e){super(t);n(this,"AUDIO_FEATURES_LIMIT",100);n(this,"tracks");this.tracks=e}dataLabels(){return["Danceability","Energy","Key","Loudness","Mode","Speechiness","Acousticness","Instrumentalness","Liveness","Valence","Tempo","Time Signature"]}async data(){const t=this.tracks.map(a=>a.id),e=[];for(let a=0;a<t.length;a=a+this.AUDIO_FEATURES_LIMIT)e.push(`https://api.spotify.com/v1/audio-features?ids=${t.slice(a,a+this.AUDIO_FEATURES_LIMIT)}`);const c=e.map(a=>u(a,this.accessToken)),o=(await Promise.all(c)).flatMap(a=>a.data.audio_features),l=new Map(o.filter(a=>a).map(a=>[a.uri,[a.danceability,a.energy,a.key,a.loudness,a.mode,a.speechiness,a.acousticness,a.instrumentalness,a.liveness,a.valence,a.tempo,a.time_signature]])),r=Array.from(l.keys());return this.tracks.filter(a=>!r.includes(a.uri)).forEach(a=>{l.set(a.uri,["","","","","","","","","","","",""])}),l}}class W extends y{constructor(t,e){super(t);n(this,"ALBUM_LIMIT",20);n(this,"tracks");this.tracks=e}dataLabels(){return["Album Genres","Label","Copyrights"]}async data(){const t=Array.from(new Set(this.tracks.filter(r=>r.album.id).map(r=>r.album.id))),e=[];for(let r=0;r<t.length;r=r+this.ALBUM_LIMIT)e.push(`https://api.spotify.com/v1/albums?ids=${t.slice(r,r+this.ALBUM_LIMIT)}`);const c=e.map(r=>u(r,this.accessToken)),o=await Promise.all(c),l=new Map(o.flatMap(r=>r.data.albums.map(a=>[a.id,[a.genres.join(", "),a.label,a.copyrights.map(f=>`${f.type} ${f.text}`).join(", ")]])));return new Map(this.tracks.map(r=>[r.uri,l.get(r.album.id)||["","",""]]))}}class V{constructor(t,e){n(this,"playlist");n(this,"trackItems");n(this,"columnNames");n(this,"lineData");n(this,"lineTrackUris");n(this,"lineTrackData");this.playlist=t,this.trackItems=e,this.columnNames=["Added By","Added At"],this.lineData=new Map,this.lineTrackUris=e.map(c=>c.track.uri),this.lineTrackData=e.map(c=>[c.added_by==null?"":c.added_by.uri,c.added_at])}async addData(t,e=!1){e?this.columnNames.unshift(...t.dataLabels()):this.columnNames.push(...t.dataLabels());const c=await t.data();this.lineTrackUris.forEach((o,l)=>{c.has(o)&&(e?this.lineTrackData[l].unshift(...c.get(o)):this.lineTrackData[l].push(...c.get(o)))})}content(){let t="";return t+=this.columnNames.map(this.sanitize).join()+`
`,this.lineTrackData.forEach(e=>{t+=e.map(this.sanitize).join(",")+`
`}),t}sanitize(t){return'"'+String(t).replace(/"/g,'""')+'"'}}class J{constructor(t,e,c){n(this,"accessToken");n(this,"playlist");n(this,"config");this.accessToken=t,this.playlist=e,this.config=c}async export(){return this.csvData().then(t=>{const e=new Blob([t],{type:"text/csv;charset=utf-8"});$.exports.saveAs(e,this.fileName())})}async csvData(){const t=new K(this.accessToken,this.playlist),e=await t.trackItems(),c=e.map(l=>l.track),o=new V(this.playlist,e);return await o.addData(t,!0),this.config.includeArtistsData&&await o.addData(new X(this.accessToken,c)),this.config.includeAudioFeaturesData&&await o.addData(new Q(this.accessToken,c)),this.config.includeAlbumData&&await o.addData(new W(this.accessToken,c)),o.content()}fileName(){return this.playlist.name.replace(/[\x00-\x1F\x7F/\\<>:;"|=,.?*[\] ]+/g,"_").toLowerCase()+".csv"}}class tt extends p.Component{constructor(){super(...arguments);n(this,"exportPlaylist",()=>{new J(this.props.accessToken,this.props.playlist,this.props.config).export().catch(m)})}renderTickCross(t){return t?s(h,{icon:["far","check-circle"],size:"sm"}):s(h,{icon:["far","times-circle"],size:"sm",style:{color:"#ECEBE8"}})}renderIcon(t){return t.name==="Liked"?s(h,{icon:["far","heart"],style:{color:"red"}}):s(h,{icon:["fas","music"]})}render(){let t=this.props.playlist;return t.uri==null?d("tr",{children:[s("td",{children:this.renderIcon(t)}),s("td",{children:t.name}),s("td",{colSpan:"2",children:"This playlist is not supported"}),s("td",{children:this.renderTickCross(t.public)}),s("td",{children:this.renderTickCross(t.collaborative)}),s("td",{children:"\xA0"})]},t.name):d("tr",{children:[s("td",{children:this.renderIcon(t)}),s("td",{children:s("a",{href:t.uri,children:t.name})}),s("td",{children:s("a",{href:t.owner.uri,children:t.owner.display_name})}),s("td",{children:t.tracks.total}),s("td",{children:this.renderTickCross(t.public)}),s("td",{children:this.renderTickCross(t.collaborative)}),s("td",{className:"text-right",children:d(g,{type:"submit",variant:"primary",size:"xs",onClick:this.exportPlaylist,className:"text-nowrap",children:[s(h,{icon:["fas","download"],size:"sm"})," Export"]})})]},t.uri)}}class et extends p.Component{constructor(){super(...arguments);n(this,"nextClick",t=>{t.preventDefault(),this.props.onPageChanged(this.props.currentPage+1)});n(this,"prevClick",t=>{t.preventDefault(),this.props.onPageChanged(this.props.currentPage-1)});n(this,"totalPages",()=>Math.ceil(this.props.totalRecords/this.props.pageLimit))}render(){return s("nav",{className:"paginator text-right",children:d("ul",{className:"pagination pagination-sm",children:[s("li",{className:this.props.currentPage<=1?"page-item disabled":"page-item",children:s("a",{className:"page-link",href:"#","aria-label":"Previous",onClick:this.prevClick,children:s("span",{"aria-hidden":"true",children:"\xAB"})})}),s("li",{className:this.props.currentPage>=this.totalPages()?"page-item disabled":"page-item",children:s("a",{className:"page-link",href:"#","aria-label":"Next",onClick:this.nextClick,children:s("span",{"aria-hidden":"true",children:"\xBB"})})})]})})}}class st extends p.Component{constructor(t){super(t);n(this,"PAGE_SIZE",20);n(this,"userId",null);n(this,"playlistsData",null);n(this,"state",{initialized:!1,searching:!1,playlists:[],playlistCount:0,likedSongs:{limit:0,count:0},currentPage:1,progressBar:{show:!1,label:"",value:0},config:{includeArtistsData:!1,includeAudioFeaturesData:!1,includeAlbumData:!1}});n(this,"loadCurrentPlaylistPage",async()=>{this.playlistSearch.current&&this.playlistSearch.current.clear();try{const t=await this.playlistsData.slice((this.state.currentPage-1)*this.PAGE_SIZE,(this.state.currentPage-1)*this.PAGE_SIZE+this.PAGE_SIZE);this.setState({initialized:!0,searching:!1,playlists:t,playlistCount:await this.playlistsData.total()},()=>{const e=(this.state.currentPage-1)*this.PAGE_SIZE+1,c=Math.min(e+this.PAGE_SIZE-1,this.state.playlistCount);this.setSubtitle(`${e}-${c} of ${this.state.playlistCount} playlists for ${this.userId}`)})}catch(t){m(t)}});n(this,"handlePlaylistsLoadingStarted",()=>{this.configDropdown.current.spin(!0)});n(this,"handlePlaylistsLoadingDone",()=>{this.configDropdown.current.spin(!1)});n(this,"handlePlaylistExportStarted",(t,e)=>{this.setState({progressBar:{show:!0,label:`Exporting ${t}...`,value:e}})});n(this,"handlePageChanged",t=>{try{this.setState({currentPage:t},this.loadCurrentPlaylistPage)}catch(e){m(e)}});this.configDropdown=p.createRef(),this.playlistSearch=p.createRef(),t.config&&(this.state.config=t.config)}setSubtitle(t){const e=document.getElementById("subtitle");e&&(e.textContent=t)}async componentDidMount(){try{const t=await u("https://api.spotify.com/v1/me",this.props.accessToken).then(e=>e.data);this.userId=t.id,this.playlistsData=new H(this.props.accessToken,this.userId,this.handlePlaylistsLoadingStarted,this.handlePlaylistsLoadingDone),await this.loadCurrentPlaylistPage()}catch(t){m(t)}}render(){const t=s(j,{striped:!0,variant:"primary",animated:this.state.progressBar.value<this.state.playlistCount,now:this.state.progressBar.value,max:this.state.playlistCount,label:this.state.progressBar.label});return this.state.initialized?d("div",{id:"playlists",children:[s("div",{style:{height:"45px"},children:this.state.progressBar.show&&t}),d("table",{className:"table table-hover table-sm",children:[s("thead",{children:d("tr",{children:[s("th",{style:{width:"30px"}}),s("th",{children:"Name"}),s("th",{style:{width:"150px"},children:"Owner"}),s("th",{style:{width:"100px"},children:"Tracks"}),s("th",{style:{width:"120px"},children:"Public?"}),s("th",{style:{width:"120px"},children:"Collaborative?"}),s("th",{style:{width:"100px"},className:"text-right"})]})}),s("tbody",{children:this.state.playlists.map(e=>s(tt,{playlist:e,accessToken:this.props.accessToken,config:this.state.config},e.id))})]}),s("div",{id:"playlistsFooter",children:s(et,{currentPage:this.state.currentPage,pageLimit:this.PAGE_SIZE,totalRecords:this.state.playlistCount,onPageChanged:this.handlePageChanged})})]}):s("div",{className:"spinner","data-testid":"playlistTableSpinner"})}}class at extends p.Component{constructor(){super(...arguments);n(this,"handleClick",()=>{window.location.href=`${window.location.href.split("#")[0]}?change_user=true`})}render(){return s(g,{id:"logoutButton",type:"submit",variant:"link",size:"lg",onClick:this.handleClick,title:"Change user",children:s(h,{icon:["fas","sign-out-alt"],size:"lg"})})}}function it(){return d("div",{id:"spotifyErrorMessage",className:"lead",children:[s("p",{children:s(h,{icon:["fas","bolt"],style:{fontSize:"50px",marginBottom:"20px"}})}),s("p",{children:"Oops, Exportify has encountered an unexpected error (5XX) while using the Spotify API. This kind of error is due to a problem on Spotify's side, and although it's rare, unfortunately all we can do is retry later."}),d("p",{style:{marginTop:"50px"},children:["Keep an eye on the"," ",s("a",{target:"_blank",rel:"noreferrer",href:"https://status.spotify.dev/",children:"Spotify Web API Status page"})," ","to see if there are any known problems right now, and then"," ",s("a",{rel:"noreferrer",href:"?",children:"retry"}),"."]})]})}function rt(){const i=new URLSearchParams(window.location.hash.substring(1));return w("spotify_error")!==""?s(k,{children:s(it,{})}):i.has("access_token")?s(k,{logoutElement:s(at,{}),children:s(st,{accessToken:i.get("access_token")})}):s(k,{children:s(G,{})})}function k({children:i,logoutElement:t=null}){return d("div",{className:"App container",children:[d("header",{className:"App-header",children:[t,d("h1",{children:[s(h,{icon:["fab","spotify"],color:"#84BD00",size:"sm"})," ","Hatlaron's Exportify"]}),s("p",{id:"subtitle",className:"lead text-secondary",children:"Export your Spotify playlists."})]}),i]})}O.render(s(q.exports.StrictMode,{children:s(rt,{})}),document.getElementById("root"));
